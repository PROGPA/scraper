<!DOCTYPE html>
<html lang="en" class="transition-colors duration-500">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Email Scraper Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', sans-serif; }
#log { max-height: 300px; overflow-y: auto; font-size: 0.9rem; padding: 0.75rem; border-radius: 0.5rem; }
.progress-bar { transition: width 0.3s ease; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
.theme-dark { background-color: #0f172a; color: #e2e8f0; }
.theme-light { background-color: #f8fafc; color: #1e293b; }
.dark-card { background-color: #1e293b; color: #e2e8f0; }
.light-card { background-color: #ffffff; color: #1e293b; }
.dark-input { background-color: #0f172a; color: #f1f5f9; border: 1px solid #334155; }
.light-input { background-color: #ffffff; color: #1e293b; border: 1px solid #cbd5e1; }
</style>
</head>

<body id="body" class="theme-light min-h-screen flex flex-col items-center py-10">
  <div id="mainCard" class="w-full max-w-5xl light-card shadow-lg rounded-2xl p-8 transition-all duration-300">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-blue-600">Email Scraper Dashboard</h1>
      <button id="themeToggle" class="text-sm bg-gray-200 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-300 transition">ðŸŒž Light</button>
    </div>

    <div class="mb-6">
      <label class="block font-semibold mb-2">Enter URLs (one per line)</label>
      <textarea id="urls" rows="6" class="w-full rounded-xl p-3 focus:ring-2 focus:ring-blue-500 light-input" placeholder="https://example.com
https://another-site.org"></textarea>
      <div class="flex items-center justify-between mt-3">
        <button id="startBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-700 transition">Start Extraction</button>
        <button id="cancelBtn" class="bg-red-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-red-700 transition hidden">Cancel Job</button>
      </div>
    </div>

    <div id="progressContainer" class="hidden mb-6">
      <div class="text-sm flex justify-between mb-2">
        <span id="progressText">Progress: 0 / 0</span>
        <span id="percentText" class="font-semibold text-blue-600"></span>
      </div>
      <div class="w-full bg-gray-300 rounded-full h-3 overflow-hidden">
        <div id="progressBar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%;"></div>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Live Log</h2>
      <div id="log" class="light-input"></div>
    </div>

    <div id="resultsContainer" class="hidden mb-6">
      <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
        <span>Results</span>
        <div class="space-x-2">
          <button id="downloadCsv" class="bg-green-600 text-white px-4 py-1 rounded-lg text-sm hover:bg-green-700">Download CSV</button>
          <button id="downloadJson" class="bg-gray-700 text-white px-4 py-1 rounded-lg text-sm hover:bg-gray-800">Download JSON</button>
        </div>
      </h2>
      <table class="w-full border border-gray-400 rounded-xl overflow-hidden text-sm">
        <thead class="bg-blue-600 text-white">
          <tr><th class="px-3 py-2 text-left">URL</th><th class="px-3 py-2 text-left">Emails</th></tr>
        </thead>
        <tbody id="resultsBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Job History</h2>
      <div id="jobsList" class="space-y-2 text-sm"></div>
    </div>

    <footer class="text-center text-gray-400 text-sm mt-6">
      <p>Powered by Local Playwright Email Scraper â€¢ <span id="statusText">Connecting...</span></p>
    </footer>
  </div>

<script>
let ws;
let currentJobId = null;
let jobResults = {};
let dark = false;
const logEl = document.getElementById("log");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const percentText = document.getElementById("percentText");
const progressContainer = document.getElementById("progressContainer");
const startBtn = document.getElementById("startBtn");
const cancelBtn = document.getElementById("cancelBtn");
const resultsBody = document.getElementById("resultsBody");
const resultsContainer = document.getElementById("resultsContainer");
const jobsList = document.getElementById("jobsList");
const statusText = document.getElementById("statusText");
const themeToggle = document.getElementById("themeToggle");
const body = document.getElementById("body");
const mainCard = document.getElementById("mainCard");

// theme toggle
function setTheme(darkMode) {
  dark = darkMode;
  body.className = dark ? "theme-dark" : "theme-light";
  mainCard.className = dark ? "w-full max-w-5xl dark-card shadow-lg rounded-2xl p-8" : "w-full max-w-5xl light-card shadow-lg rounded-2xl p-8";
  document.querySelectorAll("textarea, #log").forEach(el=>{
    el.className = dark ? "w-full rounded-xl p-3 dark-input" : "w-full rounded-xl p-3 light-input";
  });
  themeToggle.textContent = dark ? "ðŸŒ™ Dark" : "ðŸŒž Light";
  localStorage.setItem("theme", dark ? "dark" : "light");
}
themeToggle.onclick = ()=> setTheme(!dark);
setTheme(localStorage.getItem("theme")==="dark");

// utils
function appendLog(msg, color=dark?"#9ca3af":"#4b5563") {
  const p = document.createElement("div");
  p.style.color = color;
  p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logEl.appendChild(p);
  logEl.scrollTop = logEl.scrollHeight;
}
function updateProgress(done, total) {
  const pct = total ? Math.round((done / total) * 100) : 0;
  progressBar.style.width = pct + "%";
  progressText.textContent = `Progress: ${done} / ${total}`;
  percentText.textContent = pct + "%";
}
function refreshJobs() {
  fetch("/jobs").then(r=>r.json()).then(jobs=>{
    jobsList.innerHTML="";
    jobs.forEach(j=>{
      const div=document.createElement("div");
      div.className="flex justify-between items-center rounded-xl px-3 py-2 " + (dark?"bg-gray-700":"bg-gray-100");
      div.innerHTML=`<div><span class="font-semibold">${j.id}</span> â€” ${j.status} (${j.count} URLs)</div>
      <button onclick="cancelJob('${j.id}')" class="text-xs ${dark?'text-red-400':'text-red-600'} hover:underline">Cancel</button>`;
      jobsList.appendChild(div);
    });
  });
}
function cancelJob(id){
  if(ws && ws.readyState===WebSocket.OPEN){ ws.send("cancel"+id); appendLog("Sent cancel for job "+id, "#f87171"); }
}
function downloadFile(content,type,filename){
  const blob=new Blob([content],{type});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=filename;a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function downloadResults(fmt){
  if(!Object.keys(jobResults).length)return;
  if(fmt==="csv"){
    let csv="URL,Emails\n";
    for(const [u,e] of Object.entries(jobResults))csv+=`"${u}","${e.join("; ")}"\n`;
    downloadFile(csv,"text/csv","emails.csv");
  }else{
    downloadFile(JSON.stringify(jobResults,null,2),"application/json","emails.json");
  }
}
document.getElementById("downloadCsv").onclick=()=>downloadResults("csv");
document.getElementById("downloadJson").onclick=()=>downloadResults("json");

function autoSaveCSV(){
  if(!Object.keys(jobResults).length)return;
  let csv="URL,Emails\n";
  for(const [u,e] of Object.entries(jobResults))csv+=`"${u}","${e.join("; ")}"\n`;
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`emails_${Date.now()}.csv`;
  a.click();
}

function connectWS(){
  ws=new WebSocket(`ws://${location.host}/ws`);
  ws.onopen=()=>{
    statusText.textContent="Connected";
    statusText.className="text-green-600";
    appendLog("Connected to backend","#22c55e");
  };
  ws.onmessage=(ev)=>{
    let msg;
    try{ msg=JSON.parse(ev.data);}catch{appendLog(ev.data);return;}
    if(msg.type==="job_created"){
      currentJobId=msg.job_id;
      appendLog(`Job created: ${msg.job_id} (${msg.count} URLs)`,"#60a5fa");
      progressContainer.classList.remove("hidden");
      cancelBtn.classList.remove("hidden");
      startBtn.disabled=true;
      jobResults={};
      resultsBody.innerHTML="";
      resultsContainer.classList.add("hidden");
    }else if(msg.type==="progress"){
      updateProgress(msg.done,msg.total);
      const emails=msg.emails.join("; ");
      appendLog(`[${msg.done}/${msg.total}] ${msg.current} â†’ ${emails}`,"#93c5fd");
      jobResults[msg.current]=msg.emails;
    }else if(msg.type==="finished"){
      appendLog(`Job finished: ${msg.job_id}`,"#4ade80");
      updateProgress(msg.total,msg.total);
      startBtn.disabled=false;
      cancelBtn.classList.add("hidden");
      progressContainer.classList.add("hidden");
      resultsContainer.classList.remove("hidden");
      fillResults(msg.results);
      refreshJobs();
      autoSaveCSV(); // autosave CSV to downloads
    }else if(msg.type==="cancelled"){
      appendLog(`Job cancelled: ${msg.job_id}`,"#f87171");
      startBtn.disabled=false;cancelBtn.classList.add("hidden");
    }else if(msg.type==="error"){ appendLog(`Error: ${msg.msg}`,"#f87171"); }
  };
  ws.onclose=()=>{
    statusText.textContent="Disconnected";
    statusText.className="text-red-600";
    appendLog("WebSocket disconnected","#ef4444");
    setTimeout(connectWS,3000);
  };
}
function fillResults(results){
  resultsBody.innerHTML="";
  for(const [u,e]of Object.entries(results)){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="px-3 py-2">${u}</td><td class="px-3 py-2">${e.join("<br>")}</td>`;
    resultsBody.appendChild(tr);
  }
}

document.getElementById("startBtn").onclick=()=>{
  const urls=document.getElementById("urls").value.trim();
  if(!urls){alert("Please enter at least one URL");return;}
  if(ws && ws.readyState===WebSocket.OPEN)ws.send("start"+urls);
  else alert("WebSocket not connected yet. Please wait a few seconds.");
};
document.getElementById("cancelBtn").onclick=()=>{ if(currentJobId){ ws.send("cancel"+currentJobId); }};

window.addEventListener("load",()=>{ connectWS(); refreshJobs(); });
</script>
</body>
</html>
