<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Email Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .user-card {
            transition: all 0.2s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .status-active {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-blocked {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-inactive {
            background-color: #f1f5f9;
            color: #475569;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .activity-item {
            border-left: 3px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            border-left-color: #3b82f6;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto space-y-6">
            
            <div class="bg-white rounded-lg shadow-lg border border-slate-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">Admin Dashboard</h1>
                        <p class="text-slate-600 mt-1">Manage users and monitor activity</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="refresh-btn" class="px-4 py-2 bg-slate-900 text-white rounded-md hover:bg-slate-800 transition-colors flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Refresh
                        </button>
                        <a href="/" class="px-4 py-2 border border-slate-300 rounded-md hover:bg-slate-50 transition-colors flex items-center gap-2">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            Back to App
                        </a>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Total Users</p>
                            <p id="total-users" class="text-2xl font-bold text-slate-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Active Users</p>
                            <p id="active-users" class="text-2xl font-bold text-slate-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <i data-lucide="shield-off" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-600">Blocked Users</p>
                            <p id="blocked-users" class="text-2xl font-bold text-slate-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <h2 class="text-xl font-semibold text-slate-900">Users</h2>
                        <p class="text-sm text-slate-600 mt-1">Manage user accounts</p>
                    </div>
                    <div class="p-6">
                        <div id="users-container" class="space-y-3 max-h-[500px] overflow-y-auto">
                            <div class="flex items-center justify-center py-8">
                                <i data-lucide="loader-2" class="w-6 h-6 text-slate-400 spinner"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <h2 class="text-xl font-semibold text-slate-900">Recent Activity</h2>
                        <p class="text-sm text-slate-600 mt-1">Latest scraping jobs</p>
                    </div>
                    <div class="p-6">
                        <div id="activity-container" class="space-y-3 max-h-[500px] overflow-y-auto">
                            <div class="flex items-center justify-center py-8">
                                <i data-lucide="loader-2" class="w-6 h-6 text-slate-400 spinner"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="user-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-semibold text-slate-900" id="modal-user-name">User Details</h2>
                    <button id="close-modal" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4" id="modal-content">
            </div>
        </div>
    </div>

    <script>
        // Auto-detect environment
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
        const API_BASE = isLocalhost ? 'http://localhost:8000' : `${protocol}//${window.location.host}`;
        
        let users = [];
        let activities = [];

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 fade-in ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info'
            };
            
            toast.innerHTML = `
                <i data-lucide="${icons[type]}" class="w-5 h-5"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            
            return formatDate(dateString);
        }

        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/users`);
                const data = await response.json();
                users = data.users;
                renderUsers();
                updateStats();
            } catch (error) {
                console.error('Error fetching users:', error);
                showToast('Failed to load users', 'error');
            }
        }

        async function fetchActivity() {
            try {
                const response = await fetch(`${API_BASE}/api/activity`);
                const data = await response.json();
                activities = data.activities;
                renderActivity();
            } catch (error) {
                console.error('Error fetching activity:', error);
                showToast('Failed to load activity', 'error');
            }
        }

        function updateStats() {
            const totalUsers = users.length;
            const activeUsers = users.filter(u => !u.is_blocked).length;
            const blockedUsers = users.filter(u => u.is_blocked).length;
            
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('active-users').textContent = activeUsers;
            document.getElementById('blocked-users').textContent = blockedUsers;
        }

        function renderUsers() {
            const container = document.getElementById('users-container');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-8">No users yet</p>';
                return;
            }
            
            container.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card p-4 rounded-lg border border-slate-200 space-y-3';
                
                const statusClass = user.is_blocked ? 'status-blocked' : 'status-active';
                const statusText = user.is_blocked ? 'Blocked' : 'Active';
                
                userCard.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                                <h3 class="font-semibold text-slate-900">${user.name}</h3>
                            </div>
                            <p class="text-xs text-slate-500 mt-1 font-mono">${user.id}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <p class="text-slate-500">Joined</p>
                            <p class="text-slate-900">${formatDate(user.created_at).split(' ')[0]}</p>
                        </div>
                        <div>
                            <p class="text-slate-500">Last Active</p>
                            <p class="text-slate-900">${formatRelativeTime(user.last_active)}</p>
                        </div>
                        <div>
                            <p class="text-slate-500">Total Jobs</p>
                            <p class="text-slate-900">${user.total_jobs || 0}</p>
                        </div>
                        <div>
                            <p class="text-slate-500">Emails Scraped</p>
                            <p class="text-slate-900">${user.total_emails_scraped || 0}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-2">
                        <button onclick="toggleUserBlock('${user.id}', ${user.is_blocked})" 
                                class="flex-1 px-3 py-1.5 ${user.is_blocked ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white rounded-md text-sm transition-colors flex items-center justify-center gap-1">
                            <i data-lucide="${user.is_blocked ? 'check' : 'shield-off'}" class="w-4 h-4"></i>
                            ${user.is_blocked ? 'Unblock' : 'Block'}
                        </button>
                        <button onclick="showUserDetails('${user.id}')" 
                                class="flex-1 px-3 py-1.5 border border-slate-300 rounded-md text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-1">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            View Details
                        </button>
                    </div>
                `;
                
                container.appendChild(userCard);
            });
            
            lucide.createIcons();
        }

        function renderActivity() {
            const container = document.getElementById('activity-container');
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-8">No activity yet</p>';
                return;
            }
            
            container.innerHTML = '';
            
            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item pl-4 py-3 space-y-1';
                
                const urls = activity.urls ? JSON.parse(activity.urls) : [];
                const urlCount = urls.length;
                
                activityItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-slate-900">${activity.user_name}</p>
                            <p class="text-sm text-slate-600">
                                ${activity.status === 'completed' ? 'Completed scraping' : 'Started scraping'}
                                ${urlCount} URL${urlCount !== 1 ? 's' : ''}
                            </p>
                            ${activity.total_emails > 0 ? `
                                <p class="text-sm text-green-600 font-medium">
                                    Found ${activity.total_emails} email${activity.total_emails !== 1 ? 's' : ''}
                                </p>
                            ` : ''}
                        </div>
                        <span class="text-xs text-slate-500">${formatRelativeTime(activity.timestamp)}</span>
                    </div>
                `;
                
                container.appendChild(activityItem);
            });
            
            lucide.createIcons();
        }

        async function toggleUserBlock(userId, isCurrentlyBlocked) {
            try {
                const endpoint = isCurrentlyBlocked ? 'unblock-user' : 'block-user';
                const response = await fetch(`${API_BASE}/api/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                
                if (response.ok) {
                    showToast(`User ${isCurrentlyBlocked ? 'unblocked' : 'blocked'} successfully`, 'success');
                    await fetchUsers();
                } else {
                    showToast('Failed to update user status', 'error');
                }
            } catch (error) {
                console.error('Error toggling user block:', error);
                showToast('An error occurred', 'error');
            }
        }

        async function showUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/user-activity/${userId}`);
                const data = await response.json();
                const userActivities = data.activities;
                
                const modal = document.getElementById('user-detail-modal');
                const modalContent = document.getElementById('modal-content');
                
                document.getElementById('modal-user-name').textContent = user.name;
                
                let activityHTML = '<h3 class="font-semibold text-slate-900 mb-3">Activity History</h3>';
                
                if (userActivities.length === 0) {
                    activityHTML += '<p class="text-slate-500">No activity yet</p>';
                } else {
                    activityHTML += '<div class="space-y-3">';
                    userActivities.forEach(activity => {
                        const urls = activity.urls ? JSON.parse(activity.urls) : [];
                        activityHTML += `
                            <div class="p-3 border border-slate-200 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-sm font-medium text-slate-900">Job: ${activity.job_id || 'N/A'}</span>
                                    <span class="text-xs text-slate-500">${formatDate(activity.timestamp)}</span>
                                </div>
                                <div class="text-sm text-slate-600">
                                    <p>URLs: ${urls.length}</p>
                                    ${activity.total_emails > 0 ? `<p class="text-green-600">Emails found: ${activity.total_emails}</p>` : ''}
                                    <p class="capitalize">Status: ${activity.status}</p>
                                </div>
                                ${urls.length > 0 ? `
                                    <details class="mt-2">
                                        <summary class="text-xs text-blue-600 cursor-pointer">Show URLs</summary>
                                        <ul class="mt-2 text-xs text-slate-600 space-y-1">
                                            ${urls.map(url => `<li class="truncate">• ${url}</li>`).join('')}
                                        </ul>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    });
                    activityHTML += '</div>';
                }
                
                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg">
                            <div>
                                <p class="text-sm text-slate-600">User ID</p>
                                <p class="text-sm font-mono text-slate-900">${user.id}</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-600">Status</p>
                                <p class="text-sm font-medium ${user.is_blocked ? 'text-red-600' : 'text-green-600'}">
                                    ${user.is_blocked ? 'Blocked' : 'Active'}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-600">Joined</p>
                                <p class="text-sm text-slate-900">${formatDate(user.created_at)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-600">Last Active</p>
                                <p class="text-sm text-slate-900">${formatDate(user.last_active)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-600">Total Jobs</p>
                                <p class="text-sm text-slate-900">${user.total_jobs || 0}</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-600">Emails Scraped</p>
                                <p class="text-sm text-slate-900">${user.total_emails_scraped || 0}</p>
                            </div>
                        </div>
                        ${activityHTML}
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error fetching user details:', error);
                showToast('Failed to load user details', 'error');
            }
        }

        document.getElementById('close-modal').addEventListener('click', () => {
            const modal = document.getElementById('user-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        document.getElementById('refresh-btn').addEventListener('click', async () => {
            showToast('Refreshing data...', 'info');
            await Promise.all([fetchUsers(), fetchActivity()]);
        });

        async function init() {
            await Promise.all([fetchUsers(), fetchActivity()]);
            lucide.createIcons();
            
            setInterval(async () => {
                await Promise.all([fetchUsers(), fetchActivity()]);
            }, 10000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
